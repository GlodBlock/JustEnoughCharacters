import com.google.gson.GsonBuilder
import com.google.gson.JsonArray
import com.google.gson.JsonObject

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.google.code.gson:gson:2.8.9'
    }
}

task generate {
    new ClassGenerator().generate()
}

class ClassGenerator {

    private static final String MIXIN_JSON_PATTERN =
            "{\n" +
            "  \"required\": false,\n" +
            "  \"minVersion\": \"0.8\",\n" +
            "  \"package\": \"me.towdium.jecharacters.mixins\",\n" +
            "  \"plugin\": \"me.towdium.jecharacters.mixins.config.JechMixinPlugin\",\n" +
            "  \"compatibilityLevel\": \"JAVA_17\",\n" +
            "  \"client\": [\n" +
            "    MixinClasses\n" +
            "  ]\n" +
            "}"


    private static final String MIXIN_SUFFIX_CLASS_PATTERN =
            "package me.towdium.jecharacters.mixins.generated;\n" +
                    "\n" +
                    "import me.towdium.jecharacters.utils.Match;\n" +
                    "import net.minecraft.client.searchtree.SuffixArray;\n" +
                    "import org.spongepowered.asm.mixin.Mixin;\n" +
                    "import org.spongepowered.asm.mixin.Pseudo;\n" +
                    "import org.spongepowered.asm.mixin.injection.At;\n" +
                    "import org.spongepowered.asm.mixin.injection.Redirect;\n" +
                    "\n" +
                    "\n" +
                    "@SuppressWarnings({\"UnresolvedMixinReference\",\"mapping\"})\n" +
                    "@Pseudo\n" +
                    "@Mixin(targets = \"targetClass\", remap = isRemap)\n" +
                    "public class ClassName {\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"NEW\", target = \"net/minecraft/client/searchtree/SuffixArray\", remap = true))\n" +
                    "    private staticFlag SuffixArray redirectConstructor() {\n" +
                    "        return new Match.FakeArray();\n" +
                    "    }\n" +
                    "\n" +
                    "}"

    private static final String MIXIN_CONTAINS_CLASS_PATTERN =
            "package me.towdium.jecharacters.mixins.generated;\n" +
                    "\n" +
                    "import me.towdium.jecharacters.utils.Match;\n" +
                    "import org.spongepowered.asm.mixin.Mixin;\n" +
                    "import org.spongepowered.asm.mixin.Pseudo;\n" +
                    "import org.spongepowered.asm.mixin.injection.At;\n" +
                    "import org.spongepowered.asm.mixin.injection.Redirect;\n" +
                    "\n" +
                    "\n" +
                    "@SuppressWarnings({\"UnresolvedMixinReference\",\"mapping\"})\n" +
                    "@Pseudo\n" +
                    "@Mixin(targets = \"targetClass\", remap = isRemap)\n" +
                    "public class ClassName {\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Ljava/lang/String;contains(Ljava/lang/CharSequence;)Z\", remap = isRemap))\n" +
                    "    private staticFlag boolean redirectContains(String haystack, CharSequence needle) {\n" +
                    "        return Match.contains(haystack, needle);\n" +
                    "    }\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Lkotlin/text/StringsKt;contains(Ljava/lang/CharSequence;Ljava/lang/CharSequence;Z)Z\", remap = isRemap))\n" +
                    "    private staticFlag boolean redirectContainsKt1(CharSequence haystack, CharSequence needle, boolean ignoreCase) {\n" +
                    "        return Match.contains(haystack, needle, ignoreCase);\n" +
                    "    }\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Lkotlin/text/StringsKt;contains(Ljava/lang/CharSequence;Ljava/lang/CharSequence;)Z\", remap = isRemap))\n" +
                    "    private staticFlag boolean redirectContainsKt2(CharSequence haystack, CharSequence needle) {\n" +
                    "        return Match.contains(haystack, needle);\n" +
                    "    }\n" +
                    "\n" +
                    "}"

    private static final String MIXIN_EQUALS_CLASS_PATTERN =
            "package me.towdium.jecharacters.mixins.generated;\n" +
                    "\n" +
                    "import me.towdium.jecharacters.utils.Match;\n" +
                    "import org.spongepowered.asm.mixin.Mixin;\n" +
                    "import org.spongepowered.asm.mixin.Pseudo;\n" +
                    "import org.spongepowered.asm.mixin.injection.At;\n" +
                    "import org.spongepowered.asm.mixin.injection.Redirect;\n" +
                    "\n" +
                    "\n" +
                    "@SuppressWarnings({\"UnresolvedMixinReference\",\"mapping\"})\n" +
                    "@Pseudo\n" +
                    "@Mixin(targets = \"targetClass\", remap = isRemap)\n" +
                    "public class ClassName {\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Ljava/lang/String;equals(Ljava/lang/Object;)Z\", remap = isRemap))\n" +
                    "    private staticFlag boolean redirectEquals(String string, Object object) {\n" +
                    "        return Match.equals(string, object);\n" +
                    "    }\n" +
                    "\n" +
                    "}"

    private static final String MIXIN_REGEXP_CLASS_PATTERN =
            "package me.towdium.jecharacters.mixins.generated;\n" +
                    "\n" +
                    "import me.towdium.jecharacters.utils.Match;\n" +
                    "import org.spongepowered.asm.mixin.Mixin;\n" +
                    "import org.spongepowered.asm.mixin.Pseudo;\n" +
                    "import org.spongepowered.asm.mixin.injection.At;\n" +
                    "import org.spongepowered.asm.mixin.injection.Redirect;\n" +
                    "\n" +
                    "import java.util.regex.Matcher;\n" +
                    "import java.util.regex.Pattern;\n" +
                    "\n" +
                    "\n" +
                    "@SuppressWarnings({\"UnresolvedMixinReference\",\"mapping\"})\n" +
                    "@Pseudo\n" +
                    "@Mixin(targets = \"targetClass\", remap = isRemap)\n" +
                    "public class ClassName {\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Ljava/util/regex/Pattern;matcher(Ljava/lang/CharSequence;)Ljava/util/regex/Matcher;\", remap = isRemap))\n" +
                    "    private staticFlag Matcher redirectRegx(Pattern pattern, CharSequence sequence) {\n" +
                    "        return Match.matcher(pattern, sequence);\n" +
                    "    }\n" +
                    "\n" +
                    "    @Redirect(method = \"targetMethod\", at = @At(value = \"INVOKE\", target = \"Ljava/lang/String;matches(Ljava/lang/String;)Z\", remap = isRemap))\n" +
                    "    private staticFlag boolean redirectRegx(String s1, String s2) {\n" +
                    "        return Match.matches(s1, s2);\n" +
                    "    }\n" +
                    "\n" +
                    "}"

    private final Map<String, Boolean> suffix = new HashMap<>()

    private final Map<String, Boolean> contains = new HashMap()

    private final Map<String, Boolean> equals = new HashMap<>()

    private final Map<String, Boolean> regExp = new HashMap<>()

    private final List<String> mixinClasses = new ArrayList<>()

    private final Map<String,Boolean> targetMap = new HashMap<>()


    ClassGenerator(){
        //suffix
        //move to manual because we need a interface mixin
//        suffix.put('net.minecraft.client.searchtree.ResourceLocationSearchTree:create(Ljava/util/List;Ljava/util/function/Function;)Lnet/minecraft/client/searchtree/ResourceLocationSearchTree;'  // Vanilla
//        suffix.put('net.minecraft.client.searchtree.PlainTextSearchTree:create(Ljava/util/List;Ljava/util/function/Function;)Lnet/minecraft/client/searchtree/PlainTextSearchTree;'  // Vanilla
        suffix 'dev.emi.emi.search.EmiSearch:bake()V', true //EMI Search

        //contains
        contains 'com.blamejared.controlling.client.NewKeyBindsScreen:lambda$filterKeys$8(Lcom/blamejared/controlling/client/NewKeyBindsList$KeyEntry;)Z'  // Controlling
        contains 'com.blamejared.controlling.client.NewKeyBindsScreen:lambda$filterKeys$9(Lcom/blamejared/controlling/client/NewKeyBindsList$KeyEntry;)Z'  // Controlling
        contains 'com.blamejared.controlling.client.NewKeyBindsScreen:lambda$filterKeys$8(Lcom/blamejared/controlling/client/NewKeyBindsList$KeyEntry;)Z'  // Controlling
        contains 'com.blamejared.controlling.client.NewKeyBindsScreen:filterKeys()V' // Controlling
        contains 'de.ellpeck.actuallyadditions.mod.booklet.entry.BookletEntry:getChaptersForDisplay(Ljava/lang/String;)Ljava/util/List;'  // Actually Additions
        contains 'appeng.client.gui.me.patternaccess.PatternAccessTermScreen:refreshList()V'  // Applied Energistics
        contains 'appeng.client.gui.me.patternaccess.PatternAccessTermScreen:itemStackMatchesSearchTerm(Lnet/minecraft/class_1799;Ljava/lang/String;)Z'  // Applied Energistics
        contains 'me.towdium.jecalculation.utils.Utilities$I18n:contains(Ljava/lang/String;Ljava/lang/String;)Z'  // Just Enough Calculation
        contains 'vazkii.patchouli.client.book.BookEntry:isFoundByQuery(Ljava/lang/String;)Z'  // Patchouli (Botania)
        contains 'vazkii.botania.api.corporea.CorporeaRequestDefaultMatchers$CorporeaStringMatcher:equalOrContain(Ljava/lang/String;)Z'  // Botania (Corporea)
        contains 'net.blay09.mods.cookingforblockheads.container.RecipeBookContainer:search(Ljava/lang/String;)V'  // Cooking for Blockheads
        contains 'net.blay09.mods.farmingforblockheads.container.MarketClientContainer:applyFilters()V'  // Farming for Blockheads
        contains 'moze_intel.projecte.gameObjs.container.inventory.TransmutationInventory:doesItemMatchFilter(Lmoze_intel/projecte/api/ItemInfo;)Z'  // Project E
        contains 'com.mia.props.client.container.GuiDecobench:refreshButtons()V'  // Decofraft workbench
        contains 'net.minecraft.client.gui.screens.inventory.CreativeModeInventoryScreen:m_98630_()V'  // Vanilla
        contains 'net.minecraft.client.gui.screens.inventory.CreativeModeInventoryScreen:m_98619_(Ljava/lang/String;)V'  // Vanilla
        contains 'com.chaosthedude.naturescompass.gui.NaturesCompassScreen:processSearchTerm()V'  //Nature"s Compass
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TagArgumentType:matches(Lorg/apache/commons/lang3/mutable/Mutable;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z'  // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.IdentifierArgumentType:matches(Lorg/apache/commons/lang3/mutable/Mutable;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z'  // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.ModArgumentType:matches(Lorg/apache/commons/lang3/mutable/Mutable;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z'  // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TooltipArgumentType:matches(Lorg/apache/commons/lang3/mutable/Mutable;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z'  // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TextArgumentType:matches(Lorg/apache/commons/lang3/mutable/Mutable;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z'  // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.IdentifierArgumentType:matches(Ljava/lang/String;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z' // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.ModArgumentType:matches(Lme/shedaniel/rei/impl/client/search/argument/type/ModArgumentType$ModInfoPair;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z' // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TagArgumentType:matches([Ljava/lang/String;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z' // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TextArgumentType:matches(Ljava/lang/String;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z' // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.argument.type.TooltipArgumentType:matches(Ljava/lang/String;Lme/shedaniel/rei/api/common/entry/EntryStack;Ljava/lang/String;Lnet/minecraft/util/Unit;)Z' // REI legacy
        contains 'me.shedaniel.rei.impl.client.search.method.DefaultInputMethod:contains(Ljava/lang/String;Ljava/lang/String;)Z' //REI default
        contains 'dev.ftb.mods.ftblibrary.config.ui.SelectItemStackScreen$ItemStackButton:shouldAdd(Ljava/lang/String;Ljava/lang/String;)Z' //FTB Library(FTB Quests)
        contains 'dev.ftb.mods.ftblibrary.ui.misc.ButtonListBaseScreen$1:add(Ldev/ftb/mods/ftblibrary/ui/Widget;)V'//FTB Library(FTB Quests)

        contains 'me.shedaniel.clothconfig2.forge.gui.entries.DropdownBoxEntry$DefaultDropdownMenuElement:search()V'  // Cloth Config
        contains 'me.shedaniel.clothconfig2.gui.entries.DropdownBoxEntry$DefaultDropdownMenuElement:search()V'  // Cloth Config
        contains 'mezz.jei.search.ElementSearchLowMem:matches(Ljava/lang/String;Lmezz/jei/core/search/PrefixInfo;Lmezz/jei/ingredients/IListElementInfo;)Z'  // JEI (low memory)
        contains 'com.github.klikli_dev.occultism.client.gui.storage.StorageControllerGuiBase:itemMatchesSearch(Lnet/minecraft/world/item/ItemStack;)Z' // Occultism
        contains 'com.github.klikli_dev.occultism.client.gui.storage.StorageControllerGuiBase:machineMatchesSearch(Lcom/github/klikli_dev/occultism/api/common/data/MachineReference;)Z' // Occultism
        contains 'dev.emi.emi.search.NameQuery:matches(Ldev/emi/emi/api/stack/EmiStack;)Z' //EMI text search(Leagcy)
        contains 'dev.emi.emi.search.TooltipQuery:matches(Ldev/emi/emi/api/stack/EmiStack;)Z' //EMI text search(Leagcy)
        contains 'red.jackf.chesttracker.gui.widgets.WItemListPanel:lambda$updateFilter$0(Lnet/minecraft/class_1799;)Z' // Chest Tracker
        contains 'fi.dy.masa.malilib.gui.widgets.WidgetListBase:matchesFilter(Ljava/lang/String;Ljava/lang/String;)Z' // MaLiLib

        //equals
        equals 'vazkii.botania.api.corporea.CorporeaRequestDefaultMatchers$CorporeaStringMatcher:equalOrContain(Ljava/lang/String;)Z'  // Botania (Corporea)

        //Regexp
        regExp 'appeng.client.gui.me.fluids.FluidRepo:matchesSearch(Lappeng/client/gui/me/common/Repo$SearchMode;Ljava/util/regex/Pattern;Lappeng/api/storage/data/IAEFluidStack;)Z'  // Applied Energistics
        regExp 'appeng.client.gui.me.items.ItemRepo:matchesSearch(Lappeng/client/gui/me/common/Repo$SearchMode;Ljava/util/regex/Pattern;Lappeng/api/storage/data/IAEItemStack;)Z'  // Applied Energistics
        regExp 'com.tom.storagemod.gui.GuiStorageTerminalBase:updateSearch()V' // Toms Storage(Legacy)
        regExp 'com.tom.storagemod.gui.AbstractStorageTerminalScreen:updateSearch()V' // Toms Storage
        regExp 'appeng.client.gui.me.search.SearchPredicates:lambda$createNamePredicate$3(Ljava/util/regex/Pattern;Lappeng/menu/me/common/GridInventoryEntry;)Z', true //new Applied Energistics Terminals
        regExp 'appeng.client.gui.me.search.SearchPredicates:lambda$createTooltipPredicate$4(Lappeng/client/gui/me/search/RepoSearch;Ljava/util/regex/Pattern;Lappeng/menu/me/common/GridInventoryEntry;)Z', true //new Applied Energistics Terminals
        regExp 'dev.emi.emi.search.RegexNameQuery:matches(Ldev/emi/emi/api/stack/EmiStack;)Z' //EMI regex search
        regExp 'dev.emi.emi.search.RegexTooltipQuery:matches(Ldev/emi/emi/api/stack/EmiStack;)Z' //EMI regex search

    }

    void generate() {

        cleanOldClasses()

        generateClasses(MIXIN_SUFFIX_CLASS_PATTERN, "GeneratedSuffixMixin", suffix)
        generateClasses(MIXIN_CONTAINS_CLASS_PATTERN, "GeneratedContainsMixin", contains)
        generateClasses(MIXIN_EQUALS_CLASS_PATTERN, "GeneratedEqualsMixin", equals)
        generateClasses(MIXIN_REGEXP_CLASS_PATTERN, "GeneratedRegexMixin", regExp)

        putManualMixins()

        StringBuilder classes = new StringBuilder()
        for (String mixinClass : mixinClasses) {
            classes.append("\"")
                    .append(mixinClass)
                    .append("\"")
                    .append(",")
                    .append("\n")
                    .append("    ")
        }
        classes.delete(classes.length() - 6, classes.length())
        String jsonString = MIXIN_JSON_PATTERN.replace("MixinClasses", classes)
        try {
            File jsonFile = new File("src/main/resources/jecharacters.mixins.json")

            try (FileWriter writer = new FileWriter(jsonFile)) {
                writer.write(jsonString)
            } catch (IOException ignored) {
                println("Can't write to File : " + jsonFile.getPath())
            }
        } catch (FileNotFoundException ignored) {
            println("Can't find mixin config file!")
        }

        try {
            File jsonFile = new File("src/main/resources/mixins.ini")

            try (FileWriter writer = new FileWriter(jsonFile)) {
                for (Map.Entry<String,String> target : targetMap.entrySet()) {
                    writer.write(target.getKey() + ":" + target.getValue() )
                    writer.write("\n")
                }
                List<String> manuals = new ArrayList<>(mixinClasses)
                manuals.removeAll(targetMap.keySet())
                for (String manual : manuals) {
                    writer.write(manual)
                    writer.write("\n")
                }
            } catch (IOException ignored) {
                println("Can't write to File : " + jsonFile.getPath())
            }
        } catch (FileNotFoundException ignored) {
            println("Can't find mixin data file!")
        }
        println "Generating Feed"
        generateFeedJson()

    }

    void  suffix(String target) {
        suffix(target,false)
    }
    void suffix(String target, boolean isStatic) {
        suffix.put(target,isStatic)
    }

    void contains(String target) {
        contains(target,false)
    }

    void contains(String target, boolean isStatic) {
        contains.put(target, isStatic)
    }

    void equals(String target){
        equals.put(target,false)
    }

    void equals(String target, boolean isStatic){
        equals.put(target, isStatic)
    }

    void regExp(String target){
        regExp.put(target,false)
    }

    void regExp(String target, boolean isStatic) {
        regExp.put(target, isStatic)
    }

    private void cleanOldClasses() {
        File mixinsDir = new File("src/main/java/me/towdium/jecharacters/mixins/generated")
        for (File file : mixinsDir.listFiles()){
            if (file.getName().startsWith('Generated')){
                if (!file.delete()){
                    println("Can't remove generated class : " + file.getName())
                }
            }
        }
    }

    private void generateClasses(String pattern, String basedName, Map<String,Boolean> methods) {
        int index = 0
        for (Map.Entry<String, Boolean> methodEntry : methods.entrySet()) {
            String[] decode = decodeMethod(methodEntry.getKey())
            if (decode.length == 2) {
                String className = basedName + index
                boolean isRemap = methodEntry.getKey().contains("net.minecraft")
                File classFile = new File("src/main/java/me/towdium/jecharacters/mixins/generated/" + className + ".java")
                String targetMethod = decode[1]
                String realClassCode = pattern.replace("targetClass", decode[0])
                        .replace("targetMethod", targetMethod)
                        .replace("ClassName", className)
                        .replace("isRemap", Boolean.toString(isRemap))
                        .replace("staticFlag", methodEntry.getValue() ? "static" : "")
                try (FileWriter writer = new FileWriter(classFile)) {
                    writer.write(realClassCode)
                    String fullName = "generated." + className
                    mixinClasses.add(fullName)
                    targetMap.put(fullName, methodEntry.getKey())
                    index++
                } catch (IOException ignored) {
                    println("Can't write File : " + classFile.getPath())
                }
            } else {
                println("Invalid config syntax: " + methodEntry.getKey())
            }
        }

    }

    private void generateFeedJson(){
        JsonObject jsonObject = new JsonObject()
        generateSingleFeed(jsonObject, "suffix", suffix)
        generateSingleFeed(jsonObject, "contains", contains)
        generateSingleFeed(jsonObject, "equals", equals)
        generateSingleFeed(jsonObject, "regexp", regExp)
        try (FileWriter writer = new FileWriter("feed.json")) {
            String json = new GsonBuilder().setPrettyPrinting().create().toJson(jsonObject)
            writer.write(json)
        }catch (IOException ignored) {
            println("Can't write to Feed!")
        }
    }

    private static void generateSingleFeed(JsonObject object, String key, Map<String,Boolean> data){
        JsonArray commonArray = new JsonArray()
        JsonArray staticArray = new JsonArray()
        for (Map.Entry<String,Boolean> entry : data.entrySet()){
            if(entry.getValue()) {
                staticArray.add(entry.getKey())
            }else {
                commonArray.add(entry.getKey())
            }
        }
        JsonObject parent = new JsonObject()
        parent.add("common", commonArray)
        parent.add("static", staticArray)
        object.add(key, parent)
    }

    private void putManualMixins() {
        File mixinsDir = new File("src/main/java/me/towdium/jecharacters/mixins/manual")
        for (File file : mixinsDir.listFiles()) {
            if (file.getName().endsWith('.java')) {
                String className = 'manual.' +  file.getName().replace(".java", "")
                mixinClasses.add(className)
            }
        }
    }

    static String[] decodeMethod(String method) {
        return method.split(":")
    }

}